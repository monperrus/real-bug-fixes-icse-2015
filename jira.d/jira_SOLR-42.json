{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12346872","self":"https://issues.apache.org/jira/rest/api/latest/issue/12346872","key":"SOLR-42","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310230","id":"12310230","key":"SOLR","name":"Solr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310230&avatarId=22151","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310230&avatarId=22151","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310230&avatarId=22151","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310230&avatarId=22151"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10150","id":"10150","description":"Lucene-related projects","name":"Lucene"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12319065","id":"12319065","description":"Major release after 3.5","name":"3.6","archived":false,"released":true,"releaseDate":"2012-04-12"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12314992","id":"12314992","description":"Alpha release of 4.x series","name":"4.0-ALPHA","archived":false,"released":true,"releaseDate":"2012-07-03"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2007-01-04 22:21:50.112","customfield_12312323":null,"customfield_12310420":"7537","customfield_12312320":null,"customfield_12310222":"3_*:*_1_*:*_63516935_*|*_1_*:*_1_*:*_45365994972_*|*_5_*:*_2_*:*_3467370781_*|*_4_*:*_1_*:*_124404282383","customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2012-01-24T15:55:48.735+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/SOLR-42/watchers","watchCount":10,"isWatching":false},"created":"2006-07-28T20:43:04.000+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.png","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"9.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12312330":null,"customfield_12311120":null,"versions":[],"issuelinks":[{"id":"12313897","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12313897","type":{"id":"12310000","name":"Duplicate","inward":"is duplicated by","outward":"duplicates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310000"},"inwardIssue":{"id":"12353729","key":"SOLR-57","self":"https://issues.apache.org/jira/rest/api/2/issue/12353729","fields":{"summary":"Highlighter does not work with HTML content that's passed through HTMLStrip*Tokenizer","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.png","name":"Minor","id":"4"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}},{"id":"12347019","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12347019","type":{"id":"12310051","name":"Supercedes","inward":"is superceded by","outward":"supercedes","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310051"},"inwardIssue":{"id":"12538152","key":"LUCENE-3690","self":"https://issues.apache.org/jira/rest/api/2/issue/12538152","fields":{"summary":"JFlex-based HTMLStripCharFilter replacement","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/2","id":"2","description":"A new feature of the product, which has yet to be developed.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/newfeature.png","name":"New Feature","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=steve_rowe","name":"steve_rowe","emailAddress":"sarowe at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Steve Rowe","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-05-10T10:41:09.564+0000","customfield_12312335":null,"customfield_12312336":null,"customfield_12311720":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312014","id":"12312014","name":"highlighter","description":"Subsystem that finds matching hits and highlights doc snippets"}],"timeoriginalestimate":null,"description":"Indexing content that contains HTML markup, causes problems with highlighting if the HTMLStripWhitespaceTokenizerFactory is used (to prevent the tag names from being searchable).\n\nExample title field:\n\n<SUP>40</SUP>Ar/<SUP>39</SUP>Ar laserprobe dating of mylonitic fabrics in a polyorogenic terrane of NW Iberia\n\nSearching for title:fabrics with highlighting on, the highlighted version has the <em> tags in the wrong place - 22 characters to the left of where they should be (i.e. the sum of the lengths of the tags).\n\nResponse from Yonik on the solr-user mailing-list:\n\nHTMLStripWhitespaceTokenizerFactory works in two phases...\nHTMLStripReader removes the HTML and passes the result to\nWhitespaceTokenizer... at that point, Tokens are generated, but the\noffsets will correspond to the text after HTML removal, not before.\n\nI did it this way so that HTMLStripReader  could go before any\ntokenizer (like StandardTokenizer).\n\nCan you open a JIRA bug for this?  The fix would be a special version\nof HTMLStripReader integrated with a WhitespaceTokenizer to keep\noffsets correct. ","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"21139","summary":"Highlighting problems with HTMLStripWhitespaceTokenizerFactory","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amayingenta","name":"amayingenta","emailAddress":"amay at ingenta dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andrew May","active":true},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amayingenta","name":"amayingenta","emailAddress":"amay at ingenta dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andrew May","active":true},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":44,"total":44,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346872/comment/12462338","id":"12462338","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hossman","name":"hossman","emailAddress":"hossman_apachejira at fucit dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hossman&avatarId=21247","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hossman&avatarId=21247","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hossman&avatarId=21247","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hossman&avatarId=21247"},"displayName":"Hoss Man","active":true},"body":"Suggestion from Mirko on solr-dev: change HTMLStripReader to replace striped HTML with equal length whitespace.\r\n\r\n(this could possibly be made a constructor option)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hossman","name":"hossman","emailAddress":"hossman_apachejira at fucit dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hossman&avatarId=21247","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hossman&avatarId=21247","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hossman&avatarId=21247","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hossman&avatarId=21247"},"displayName":"Hoss Man","active":true},"created":"2007-01-04T22:21:50.112+0000","updated":"2007-01-04T22:21:50.112+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346872/comment/12480554","id":"12480554","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=paulfryer","name":"paulfryer","emailAddress":"fryerpaul at hotmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Paul Fryer","active":true},"body":"Any update on this? I was hoping to use Solr to do full text search of HTML documents and provide snippets with search terms highlighted.  I assume I won't be able to provide accurate HTML snippet highlighting until this issue is resolved - correct? If so, what sort of time frame would be be looking at? Anything I can contribute to help?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=paulfryer","name":"paulfryer","emailAddress":"fryerpaul at hotmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Paul Fryer","active":true},"created":"2007-03-13T21:37:01.523+0000","updated":"2007-03-13T21:37:01.523+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346872/comment/12480555","id":"12480555","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hossman","name":"hossman","emailAddress":"hossman_apachejira at fucit dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hossman&avatarId=21247","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hossman&avatarId=21247","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hossman&avatarId=21247","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hossman&avatarId=21247"},"displayName":"Hoss Man","active":true},"body":"the most helpful contribution would be a patch containing a JUnit test demonstrating hte problem and the necessary fix :)\r\n\r\nhttp://wiki.apache.org/solr/HowToContribute","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hossman","name":"hossman","emailAddress":"hossman_apachejira at fucit dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hossman&avatarId=21247","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hossman&avatarId=21247","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hossman&avatarId=21247","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hossman&avatarId=21247"},"displayName":"Hoss Man","active":true},"created":"2007-03-13T21:40:12.457+0000","updated":"2007-03-13T21:40:12.457+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346872/comment/12532570","id":"12532570","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skeptikos","name":"skeptikos","emailAddress":"jjl at panix dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"J.J. Larrea","active":true},"body":"Here is the workaround I am using, along with a long comment explaining why:\r\n\r\n{code:title=solrconfig.xml}\r\n\t\t<!--\r\n\t\t\tSpecial-case stuff for HTML tags in Abstract field:\r\n\t\t\tOriginally we had\r\n\t\t\t\t<tokenizer class=\"solr.HTMLStripWhitespaceTokenizerFactory\"/>\r\n\t\t\tbut pre-stripping destroys offsets needed for highiighting.\r\n\t\t\tTried an HTML tag-extraction RegEx as a post-process\r\n\t\t\t\t<tokenizer class=\"solr.WhitespaceTokenizerFactory\"/>\r\n\t\t\t\t<filter class=\"solr.PatternReplaceFilterFactory\"\r\n\t\t\t\t\tpattern=\"&lt;/?\\w+((\\s+\\w+(\\s*=\\s*(?:&quot;.*?&quot;|'.*?'|[^'&quot;>\\s]+))?)+\\s*|\\s*)/?&gt;\"\r\n\t\t\t\t\treplacement=\"\"\r\n\t\t\t\t\treplace=\"all\"/>\r\n\t\t\tbut it still doesn't adjust the offset and the subsequent WDF then created havoc.\r\n\t\t\tOne solution is to split on whitespace or tag delimiters (making tags\r\n\t\t\tinto text), and either index the tags or use StopFilter to remove 'em.\r\n\t\t\tBut the chosen solution is to swallow an entire chain of tags and any whitespace\r\n\t\t\twhich surrounds or separates them, leaving non-HTML < and > intact, or else runs\r\n\t\t\tof whitespace as normal.\r\n\r\n\t\t-->\r\n\t\t\t<tokenizer class=\"solr.PatternTokenizerFactory\"\r\n\t\t\t\t\tpattern=\"(?:\\s*&lt;/?\\w+((\\s+\\w+(\\s*=\\s*(?:&quot;.*?&quot;|'.*?'|[^'&quot;>\\s]+))?)+\\s*|\\s*)/?&gt;\\s*)++|\\s+\"/>\r\n\t\t\t<filter class=\"solr.ISOLatin1AccentFilterFactory\"/>\r\n\t\t\t...\r\n{code}\r\n\r\nwithout the XMLEncoding the RegEx is:\r\n\r\n\t\t\t{{(?:\\s*</?\\w+((\\s+\\w+(\\s*=\\s*(?:\"*?&\"'.*?'|[^'\">\\s]+))?)+\\s*|\\s*)/?>\\s*)++|\\s+}}\r\n\r\nand it will treat runs of \"things that look like HTML/XML open or close tags with optional attributes, optionally preceded or followed by spaces\" identically to \"runs of one or more spaces\" as token delimiters, and swallow them up, so the previous and following tokens have the correct offsets.\r\n\r\nOf course this is just a hack: It doesn't have any real understanding of HTML or XML syntax, so something invalid like </closing attr=\"x\"/> will get matched.  On the other hand, < and > in text will be left alone.  \r\n\r\nAlso note it doesn't decode XML or HTML numeric or symbolic entity references, as HTMLStripReader does (my indexer is pre-decoding the entity references before sending the text to Solr for indexing).\r\n\r\nSo fixing HTMLStripReader and its dependent HTMLStripXXXTokenizers to do the right thing with offsets would still be a worthy task.  I wonder whether recasting HTMLStripReader using the org.apache.lucene.analysis.standard.CharStream interface would make sense for this?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skeptikos","name":"skeptikos","emailAddress":"jjl at panix dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"J.J. Larrea","active":true},"created":"2007-10-05T04:37:27.858+0000","updated":"2007-10-05T05:03:50.565+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346872/comment/12542184","id":"12542184","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stuartsierra","name":"stuartsierra","emailAddress":"mail at stuartsierra dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stuart Sierra","active":true},"body":"Another workaround is simply to strip HTML tags and entities before sending the document to Solr.  This gives correct highlights.  But if you want to retrieve the original HTML document you'll need to stash it somewhere else.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stuartsierra","name":"stuartsierra","emailAddress":"mail at stuartsierra dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stuart Sierra","active":true},"created":"2007-11-13T17:58:12.494+0000","updated":"2007-11-13T17:58:12.494+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346872/comment/12555559","id":"12555559","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gsingers","name":"gsingers","emailAddress":"gsingers at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Grant Ingersoll","active":true},"body":"Might a solution to this be to replace the removed characters with whitespace, thus preserving the input offsets?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gsingers","name":"gsingers","emailAddress":"gsingers at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Grant Ingersoll","active":true},"created":"2008-01-03T12:54:51.771+0000","updated":"2008-01-03T12:54:51.771+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346872/comment/12555577","id":"12555577","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gsingers","name":"gsingers","emailAddress":"gsingers at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Grant Ingersoll","active":true},"body":"Here's the start of a test for the HTMLStripReader.  Note, in order to incorporate my suggestion of replacing HTML tags w/ whitespace, this test would need to be modified.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gsingers","name":"gsingers","emailAddress":"gsingers at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Grant Ingersoll","active":true},"created":"2008-01-03T14:15:27.502+0000","updated":"2008-01-03T14:15:27.502+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346872/comment/12555601","id":"12555601","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gsingers","name":"gsingers","emailAddress":"gsingers at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Grant Ingersoll","active":true},"body":"Patch that replaces HTML cruft with whitespace, thus preserving highlighting at the expense of extra characters.  Also included the a test file and test case\r\n\r\nNOTE: This is not backward-compatible with old HTMLStripReader, but seeing how it requires re-indexing to use anyway, I don't see that it is a concern.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gsingers","name":"gsingers","emailAddress":"gsingers at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Grant Ingersoll","active":true},"created":"2008-01-03T16:20:52.581+0000","updated":"2008-01-03T16:21:46.023+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346872/comment/12556098","id":"12556098","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gsingers","name":"gsingers","emailAddress":"gsingers at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Grant Ingersoll","active":true},"body":"Hmm, I don't know if this completely solves the problem even though the code seems like it is right.  I am still having trouble w/ the offsets.\r\n\r\nhas anyone else tried the patch?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gsingers","name":"gsingers","emailAddress":"gsingers at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Grant Ingersoll","active":true},"created":"2008-01-04T22:43:55.794+0000","updated":"2008-01-04T22:43:55.794+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346872/comment/12556104","id":"12556104","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yseeley%40gmail.com","name":"yseeley@gmail.com","emailAddress":"yseeley at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yonik Seeley","active":true},"body":"Grant, I'm getting a test failure... did you forget to \"svn add\" some files?\r\n\r\n    <error message=\"src\\test\\test-files\\htmlStripReaderTest.html (The system ca\r\nnot find the path specified)\" type=\"java.io.FileNotFoundException\">java.io.File\r\notFoundException: src\\test\\test-files\\htmlStripReaderTest.html (The system cann\r\nt find the path specified)\r\n        at java.io.FileInputStream.open(Native Method)\r\n        at java.io.FileInputStream.&lt;init&gt;(FileInputStream.java:106)\r\n        at java.io.FileReader.&lt;init&gt;(FileReader.java:55)\r\n        at org.apache.solr.analysis.HTMLStripReaderTest.testHTML(HTMLStripReade\r\nTest.java:65)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yseeley%40gmail.com","name":"yseeley@gmail.com","emailAddress":"yseeley at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yonik Seeley","active":true},"created":"2008-01-04T22:58:47.114+0000","updated":"2008-01-04T22:58:47.114+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346872/comment/12556113","id":"12556113","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gsingers","name":"gsingers","emailAddress":"gsingers at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Grant Ingersoll","active":true},"body":"There is definitely still an issue w/ the HTMLStripReader in some circumstances, working on a test now.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gsingers","name":"gsingers","emailAddress":"gsingers at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Grant Ingersoll","active":true},"created":"2008-01-04T23:24:28.628+0000","updated":"2008-01-04T23:24:28.628+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346872/comment/12556115","id":"12556115","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gsingers","name":"gsingers","emailAddress":"gsingers at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Grant Ingersoll","active":true},"body":"Here is the file.  It shows it as being added in svn stat, but not sure why it wasn't included.\r\n\r\nIt goes in src/test/test-files\r\n\r\nIt's just a copy of site/index.html","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gsingers","name":"gsingers","emailAddress":"gsingers at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Grant Ingersoll","active":true},"created":"2008-01-04T23:31:18.324+0000","updated":"2008-01-04T23:31:18.324+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346872/comment/12556149","id":"12556149","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gsingers","name":"gsingers","emailAddress":"gsingers at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Grant Ingersoll","active":true},"body":"{quote}\r\nThere is definitely still an issue w/ the HTMLStripReader in some circumstances, working on a test now.\r\n{quote}\r\n\r\nRed herring.  The problem I was seeing is due to some tags that are valid syntax for my text are being stripped.  I think this patch can go ahead, although it might be useful to keep certain tags (i.e. a set of tags)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gsingers","name":"gsingers","emailAddress":"gsingers at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Grant Ingersoll","active":true},"created":"2008-01-05T01:12:25.611+0000","updated":"2008-01-05T01:12:25.611+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346872/comment/12556158","id":"12556158","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yseeley%40gmail.com","name":"yseeley@gmail.com","emailAddress":"yseeley at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yonik Seeley","active":true},"body":"Hmmm, I'm still getting the exception, even after adding the file.\r\nDid you test with \"ant clean test\", or with a GUI?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yseeley%40gmail.com","name":"yseeley@gmail.com","emailAddress":"yseeley at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yonik Seeley","active":true},"created":"2008-01-05T02:06:38.485+0000","updated":"2008-01-05T02:06:38.485+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346872/comment/12556160","id":"12556160","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yseeley%40gmail.com","name":"yseeley@gmail.com","emailAddress":"yseeley at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yonik Seeley","active":true},"body":"To elaborate, I think the CWD when running tests under ant is \"src\\test\\test-files\", so adding that to the filename when you try to open the file seems incorrect.  To match ant, I have intellij set up to use src\\test\\test-files as the CWD when running tests.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yseeley%40gmail.com","name":"yseeley@gmail.com","emailAddress":"yseeley at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yonik Seeley","active":true},"created":"2008-01-05T02:09:25.629+0000","updated":"2008-01-05T02:09:25.629+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346872/comment/12556161","id":"12556161","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gsingers","name":"gsingers","emailAddress":"gsingers at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Grant Ingersoll","active":true},"body":"You are right.  I forgot that the CWD is different for Solr.  Feel  \r\nfree to strip off that initial path stuff, or I can generate a new  \r\npatch.\r\n\r\n-Grant\r\n\r\n\r\n\r\n--------------------------\r\nGrant Ingersoll\r\nhttp://lucene.grantingersoll.com\r\nhttp://www.lucenebootcamp.com\r\n\r\nLucene Helpful Hints:\r\nhttp://wiki.apache.org/lucene-java/BasicsOfPerformance\r\nhttp://wiki.apache.org/lucene-java/LuceneFAQ\r\n\r\n\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gsingers","name":"gsingers","emailAddress":"gsingers at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Grant Ingersoll","active":true},"created":"2008-01-05T02:44:39.242+0000","updated":"2008-01-05T02:44:39.242+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346872/comment/12556226","id":"12556226","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gsingers","name":"gsingers","emailAddress":"gsingers at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Grant Ingersoll","active":true},"body":"Here's a new version, with some more testing and the ability to preserve certain tags via a passed in set.  This is useful for text where some tags are meaningful or at least are useful further down the chain.  I am not sure why the html test file is not included.  svn stat shows:\r\n{quote}\r\nA  +   src/test/test-files/htmlStripReaderTest.html\r\nA      src/test/org/apache/solr/analysis/HTMLStripReaderTest.java\r\nM      src/java/org/apache/solr/analysis/HTMLStripReader.java\r\n{quote}\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gsingers","name":"gsingers","emailAddress":"gsingers at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Grant Ingersoll","active":true},"created":"2008-01-05T13:55:00.714+0000","updated":"2008-01-05T13:55:00.714+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346872/comment/12556247","id":"12556247","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yseeley%40gmail.com","name":"yseeley@gmail.com","emailAddress":"yseeley at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yonik Seeley","active":true},"body":"committed.  Thanks Grant!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yseeley%40gmail.com","name":"yseeley@gmail.com","emailAddress":"yseeley at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yonik Seeley","active":true},"created":"2008-01-05T16:01:35.822+0000","updated":"2008-01-05T16:01:35.822+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346872/comment/12556634","id":"12556634","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gsingers","name":"gsingers","emailAddress":"gsingers at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Grant Ingersoll","active":true},"body":"Hmmm, still seems to be a problem with entities.  I think we need to replace the entity w/ the appropriate amount of whitespace.  I will work up test and patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gsingers","name":"gsingers","emailAddress":"gsingers at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Grant Ingersoll","active":true},"created":"2008-01-07T17:30:19.244+0000","updated":"2008-01-07T17:30:19.244+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346872/comment/12556636","id":"12556636","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yseeley%40gmail.com","name":"yseeley@gmail.com","emailAddress":"yseeley at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yonik Seeley","active":true},"body":"Hmmm, this points out a deficiency in this approach... it could break up words or tokens (with whitespace) that were not originally separated (think international char in the middle of a word).\r\nSo I think this approach is probably OK for now, but a better approach would have the tokenizer get the offsets from the reader somehow (perhaps just a whitespace tokenizer with HTML stripping integrated).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yseeley%40gmail.com","name":"yseeley@gmail.com","emailAddress":"yseeley at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yonik Seeley","active":true},"created":"2008-01-07T17:37:26.818+0000","updated":"2008-01-07T17:37:26.818+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346872/comment/12556659","id":"12556659","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gsingers","name":"gsingers","emailAddress":"gsingers at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Grant Ingersoll","active":true},"body":"OK, here's a patch for the entity problem, but yes, I do agree Yonik, a better approach is needed.\r\n\r\nIt might be as simple as the SolrHighlighter being aware the the HTMLStripReader is being used.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gsingers","name":"gsingers","emailAddress":"gsingers at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Grant Ingersoll","active":true},"created":"2008-01-07T19:21:24.671+0000","updated":"2008-01-07T19:21:24.671+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346872/comment/12556668","id":"12556668","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=klaasm","name":"klaasm","emailAddress":"mike dot klaas at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Klaas","active":true},"body":"> It might be as simple as the SolrHighlighter being aware the the HTMLStripReader is being used.\r\n\r\nGrant, thanks for looking in to this issue.  What do you imagine the highlighter being able to do with that knowledge?  \r\n\r\nNote that the entity problem is an issue for search, not just highlighting.  The proper tokens will not be created in the case of international chars","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=klaasm","name":"klaasm","emailAddress":"mike dot klaas at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Klaas","active":true},"created":"2008-01-07T19:51:35.353+0000","updated":"2008-01-07T19:51:35.353+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346872/comment/12556670","id":"12556670","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gsingers","name":"gsingers","emailAddress":"gsingers at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Grant Ingersoll","active":true},"body":"{quote}\r\nWhat do you imagine the highlighter being able to do with that knowledge?\r\n{quote}\r\n\r\nMy understanding of looking at the code is the disjoint comes from line 298.  In the call to Lucene's highlighter, we pass in the TokenStream, which has been stripped (or will be stripped if the the HTMLStripReader is employed) and the value from the stored field (docTexts[0]).  If, docTexts[0] was stripped first, then I _think_ the offsets would be the same, no?  Of course, it would be really easy to test.  \r\n\r\nOf course, the real answer may be as suggested earlier and to apply the stripreader before sending to Solr.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gsingers","name":"gsingers","emailAddress":"gsingers at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Grant Ingersoll","active":true},"created":"2008-01-07T20:02:38.479+0000","updated":"2008-01-07T20:02:38.479+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346872/comment/12556676","id":"12556676","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=klaasm","name":"klaasm","emailAddress":"mike dot klaas at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Klaas","active":true},"body":"> Of course, the real answer may be as suggested earlier and to apply the stripreader before sending to Solr.\r\n\r\nHTMLStripTokenizer currently breaks the tokenizer contract, so it seems like the real answer is to fix the offsets.  I've glanced at the code, and it would be a significant amount of work to make the current implementation adhere to this contract.  The main problem is that no-one is really interested in doing this work.\r\n\r\n> > What do you imagine the highlighter being able to do with that knowledge?\r\n\r\n> My understanding of looking at the code is the disjoint comes from line 298. In the call to Lucene's highlighter, we pass in the TokenStream, which has > been stripped (or will be stripped if the the HTMLStripReader is employed) and the value from the stored field (docTexts[0]). If, docTexts[0] was stripped first, > then I think the offsets would be the same, no? Of course, it would be really easy to test.\r\n\r\nYou know, this is incredibly hacky, but I think that it is a great idea.\r\n\r\n-Mike\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=klaasm","name":"klaasm","emailAddress":"mike dot klaas at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Klaas","active":true},"created":"2008-01-07T20:12:41.516+0000","updated":"2008-01-07T20:12:41.516+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346872/comment/12556729","id":"12556729","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hossman","name":"hossman","emailAddress":"hossman_apachejira at fucit dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hossman&avatarId=21247","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hossman&avatarId=21247","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hossman&avatarId=21247","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hossman&avatarId=21247"},"displayName":"Hoss Man","active":true},"body":"I don't know much about unicode, but there are *so* many special characters in unicode, i just have to wonder if there is a special marker character that could be used instead of whitespace to \"fill in the gaps\" left when converting entities to real characters (or stripping tags).  ... something that isn't printable, and does't trigger any \"boundary\" logic (ie: note whitespace, punctuation, letter, digit, etc...)\r\n\r\n * NUL perhaps?  (can you legally embed null in a string in java?)\r\n * does anyone understand the definition of a \"nonspacing mark\" ?\r\n * the \"Invisible Separator\" character?\r\n * a \"private use\" character?  (this actually seems like the most promising option)\r\n\r\nI say we just punt: have two options that allows users to specify characters: one for when tags are striped, one for when entities are converted to normal characters ... default both to an empty string (ie: current behavior)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hossman","name":"hossman","emailAddress":"hossman_apachejira at fucit dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hossman&avatarId=21247","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hossman&avatarId=21247","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hossman&avatarId=21247","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hossman&avatarId=21247"},"displayName":"Hoss Man","active":true},"created":"2008-01-07T21:56:38.829+0000","updated":"2008-01-07T21:56:38.829+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346872/comment/12556740","id":"12556740","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yseeley%40gmail.com","name":"yseeley@gmail.com","emailAddress":"yseeley at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yonik Seeley","active":true},"body":"{quote}i just have to wonder if there is a special marker character that could be used instead of whitespace{quote}\r\nFor a hack, not a bad idea...\r\nThere could be a TokenFilter that removes any such characters in tokens, and it could even be automatically used by Tokenizers that use the html strip reader.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yseeley%40gmail.com","name":"yseeley@gmail.com","emailAddress":"yseeley at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yonik Seeley","active":true},"created":"2008-01-07T22:15:12.520+0000","updated":"2008-01-07T22:15:12.520+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346872/comment/12556748","id":"12556748","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hossman","name":"hossman","emailAddress":"hossman_apachejira at fucit dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hossman&avatarId=21247","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hossman&avatarId=21247","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hossman&avatarId=21247","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hossman&avatarId=21247"},"displayName":"Hoss Man","active":true},"body":"Hmmm.... I was assuming this would be an option on both the HTMLStripReader and the Tokenizers that use it (the tokenizers taking the option only to pass it on to the Reader) but i see what you mean ... once the Tokenizer knows the character positions of the \"words\" coming out of the text, it can then strip out those characters (Hmmm... strip the characters that are a placeholder for when other characters where already striped ... why do i feel like we're going to go to hell for this?)\r\n\r\nTf there were characters that we were *certain* would never appear in any unicode string, we could do it all under the covers by picking one of them ... but the safest thing to do would still be to have it as an option (but with a sensible default from the \"private use\" range instead of an empty string).  ... \r\n\r\nSo the HtmlStripReader would have a constructor that looks like...\r\n\r\n{code}\r\n   /** \r\n   * @param entityFiller character to replace gaps made when entities are collapsed to real characters so that character positions still line up, may be null if no filler should be used \r\n   * @param tagFiller character to replace gaps made when entities are collapsed to real characters so that character positions still line up, may be null if no filler should be used \r\n   */\r\n  public HtmlStripReader(Reader input, Character entityFiller, Character tagFiller) { ... }\r\n{code}\r\n\r\nand the Tokenizers could look like...\r\n\r\n{code}\r\npublic class HTMLStripStandardTokenizerFactory extends BaseTokenizerFactory {\r\n  Pattern fillerPattern;\r\n  Character entityFiller, tagFiller; \r\n  public void init(...) {\r\n    entityFiller = getInitParam(...);\r\n    tagFiller = getInitParam(...)\r\n    fillerPattern = getInitParam(stripFiller) ? makePattern(entityFiller, tagFiller) : null;\r\n  }\r\n  public TokenStream create(Reader input) {\r\n    TokenStream s = new StandardTokenizer(new HTMLStripReader(input,entityFiller, tagFiller);\r\n    If (null != fillerPatterm) {\r\n      s = new PatternReplaceFiler(s, fillerPattern, \"\", true);\r\n    }\r\n    return s;\r\n  }\r\n}\r\n{code}\r\n\r\nthat should totally work right?\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hossman","name":"hossman","emailAddress":"hossman_apachejira at fucit dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hossman&avatarId=21247","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hossman&avatarId=21247","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hossman&avatarId=21247","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hossman&avatarId=21247"},"displayName":"Hoss Man","active":true},"created":"2008-01-07T22:35:07.313+0000","updated":"2008-01-07T22:35:07.313+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346872/comment/12556928","id":"12556928","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gsingers","name":"gsingers","emailAddress":"gsingers at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Grant Ingersoll","active":true},"body":"Yet another problem: \r\nIn certain circumstances, it is possible that restoreState() cannot be invoked b/c the mark has been lost due to moving well beyond it.  This is most noticeable in the while (true) loop inside of readProcessingInstruction() and can be caused by the following test:\r\n{code}\r\npublic void testQuestionMark() throws Exception {\r\n    StringBuilder testBuilder = new StringBuilder(5020);\r\n    testBuilder.append(\"ah<?> \");\r\n    for (int i = 0; i < 5000; i++){\r\n      testBuilder.append('a');//tack on enough to go beyond the mark readahead limit, since <?> makes HTMLStripReader think it is a processing instruction\r\n    }\r\n    String test = testBuilder.toString();\r\n    Reader reader = new HTMLStripReader(new BufferedReader(new StringReader(test)));//force the use of BufferedReader\r\n    int ch = 0;\r\n    StringBuilder builder = new StringBuilder();\r\n    try {\r\n      while ((ch = reader.read()) != -1){\r\n        builder.append((char)ch);\r\n      }\r\n    } finally {\r\n      System.out.println(\"String: \" + builder.toString());\r\n    }\r\n    assertTrue(builder.toString() + \" is not equal to \" + test, builder.toString().equals(test) == true);\r\n  }\r\n{code}\r\n\r\nIn this case, the final assert never gets hit, because there is an IOException in reader.read of:\r\n{noformat}\r\njava.io.IOException: Mark invalid\r\n\tat java.io.BufferedReader.reset(BufferedReader.java:485)\r\n\tat org.apache.solr.analysis.HTMLStripReader.restoreState(HTMLStripReader.java:158)\r\n\tat org.apache.solr.analysis.HTMLStripReader.read(HTMLStripReader.java:731)\r\n\tat org.apache.solr.analysis.HTMLStripReaderTest.testQuestionMark(HTMLStripReaderTest.java:171)\r\n{noformat}\r\n\r\nI will add that this is based off of text seen in the wild.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gsingers","name":"gsingers","emailAddress":"gsingers at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Grant Ingersoll","active":true},"created":"2008-01-08T16:19:26.124+0000","updated":"2008-01-08T16:21:34.832+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346872/comment/12556946","id":"12556946","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gsingers","name":"gsingers","emailAddress":"gsingers at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Grant Ingersoll","active":true},"body":"OK, I think the solution for these pieces is to change the \r\nwhile (true) loops inside of HTMLStripReader to only read up to READAHEAD chars so that it can always fall back to the last mark\r\n\r\n\r\nI will work up a patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gsingers","name":"gsingers","emailAddress":"gsingers at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Grant Ingersoll","active":true},"created":"2008-01-08T17:06:58.577+0000","updated":"2008-01-08T17:06:58.577+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346872/comment/12557256","id":"12557256","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gsingers","name":"gsingers","emailAddress":"gsingers at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Grant Ingersoll","active":true},"body":"OK, I'm 99.99% confident this fixes the issues w/ the while (true) loops and handles entities properly, etc.  and highlighting works correctly.  Added more tests, etc.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gsingers","name":"gsingers","emailAddress":"gsingers at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Grant Ingersoll","active":true},"created":"2008-01-09T12:50:11.413+0000","updated":"2008-01-09T12:50:11.413+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346872/comment/12557395","id":"12557395","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ehatcher","name":"ehatcher","emailAddress":"ehatcher at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ehatcher&avatarId=22298","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ehatcher&avatarId=22298","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ehatcher&avatarId=22298","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ehatcher&avatarId=22298"},"displayName":"Erik Hatcher","active":true},"body":"patch applied, all tests still pass, and committed.  Thanks Grant!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ehatcher","name":"ehatcher","emailAddress":"ehatcher at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ehatcher&avatarId=22298","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ehatcher&avatarId=22298","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ehatcher&avatarId=22298","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ehatcher&avatarId=22298"},"displayName":"Erik Hatcher","active":true},"created":"2008-01-09T19:41:44.599+0000","updated":"2008-01-09T19:41:44.599+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346872/comment/12569035","id":"12569035","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ryguasu","name":"ryguasu","emailAddress":"ryguasu at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Harris","active":true},"body":"The committed HtmlStripReader doesn't seem to handle offsets correctly for XML processing instructions such as this:\r\n\r\n    <?xml version=\"1.0\" encoding=\"UTF-8\" ?>\r\n\r\nI'm attaching two files:\r\n\r\nHtmlStripReaderTestXmlProcessing.patch adds an HtmlStripReader test case to catch the problem. (The test currently fails.)\r\n\r\nTokenPrinter.java can help make it a little clearer what the problem actually is. Here is the output if I run it against against the analysis code in trunk. Note that the offsets are basically what one would expect, except in the XML processing instructions case, where the start position is off by one:\r\n\r\n-------------------------------------\r\nString to test: <uniqueKey>id</uniqueKey>\r\n Token info:\r\n   token 'id'\r\n     startOffset: 11\r\n     char at startOffset, and next few: 'id</u'\r\n-------------------------------------\r\nString to test: <!-- Unless this field is marked with required=\"false\", it will be a required field -->\r\n<uniqueKey>id</uniqueKey>\r\n Token info:\r\n   token 'id'\r\n     startOffset: 99\r\n     char at startOffset, and next few: 'id</u'\r\n-------------------------------------\r\nString to test: <!-- And now: two elements --> <element1>one</element1>\r\n <element2>two</element2>\r\n Token info:\r\n   token 'one'\r\n     startOffset: 41\r\n     char at startOffset, and next few: 'one</'\r\n   token 'two'\r\n     startOffset: 68\r\n     char at startOffset, and next few: 'two</'\r\n-------------------------------------\r\nString to test: <?xml version=\"1.0\" encoding=\"UTF-8\" ?><uniqueKey>id</uniqueKey>\r\n Token info:\r\n   token 'id'\r\n     startOffset: 49\r\n     char at startOffset, and next few: '>id</'\r\n-------------------------------------","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ryguasu","name":"ryguasu","emailAddress":"ryguasu at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Harris","active":true},"created":"2008-02-14T18:37:35.750+0000","updated":"2008-02-14T18:37:35.750+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346872/comment/12570338","id":"12570338","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ryguasu","name":"ryguasu","emailAddress":"ryguasu at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Harris","active":true},"body":"Updating test case to reflect the fact that offset info still gets screwed up in the XML processing instruction case even if there are no XML elements in the source XML","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ryguasu","name":"ryguasu","emailAddress":"ryguasu at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Harris","active":true},"created":"2008-02-19T17:49:00.254+0000","updated":"2008-02-19T17:49:00.254+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346872/comment/12620545","id":"12620545","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=solrize","name":"solrize","emailAddress":"no at email dot please","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"solrize","active":true},"body":"I am getting a ton of these errors in real documents with the 2008-07-30 nightly build.  Any advice?  Thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=solrize","name":"solrize","emailAddress":"no at email dot please","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"solrize","active":true},"created":"2008-08-07T08:09:39.139+0000","updated":"2008-08-07T08:09:39.139+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346872/comment/12625835","id":"12625835","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=imjimmurphy","name":"imjimmurphy","emailAddress":"jim dot murphy at pobox dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jim Murphy","active":true},"body":"I've tracked down some background info on this issue - at least the way it was affecting me.  I could care less about highlighting - I'm using the HTMLStripWhitespaceTokenizerFactory during indexing to tokenize blog content - which obviously contains lots of html.  \r\n\r\nThe pathological case I've found with our input document set is:\r\n\r\nContent contains a malformed xml processing instruction in the first \"page\" of the buffer that contains more than one page of data.\r\n\r\nIt seems this is a fairly common (maybe MS Word XML?) form of invalid HTML.  Commonly it looks like this:\r\n\r\n...valid html...<?xml:namespace prefix = o />...valid html...\r\n\r\nNotice the PI starts with \"<?xml\" but terminates with a close tag., doh.\r\n\r\nThis issue is manifested in HTMLStripReader. It causes the following code to read too much off the buffer and invalidates the previous mark at the beginning of the tag.\r\n\r\nprivate int readProcessingInstruction() throws IOException {\r\n    // \"<?\" has already been read\r\n    while ((numRead - lastMark) < readAheadLimitMinus1) {\r\n      int ch = next();\r\n      if (ch=='?' && peek()=='>') {\r\n        next();\r\n        return MATCH;\r\n      } else if (ch==-1) {\r\n        return MISMATCH;\r\n      }\r\n\r\n    }\r\n    return MISMATCH;\r\n  }\r\n\r\nThe demoralizing part is the special treatment (readAheadLimitMinus1) isn't enough.  There is actually a \"over read\" by 2 chars.\r\n\r\nThe IOException - Invalid Mark happens when readProcessingInstruction() retuns (a mismatch because the entire buffer is read without finding the close PI) and restoreState(); is called to reset the marks - which fails.\r\n\r\nIf I tweak readAheadLimitMinus1 like this\r\n\r\nreadAheadLimitMinus1 -= 2 \r\n\r\nSo maybe the variable should be readAheadLimitMinus3 ;)\r\n\r\nthen the buffer limits are preserved and the exception isn't found, parsing proceedes as expected.\r\n\r\nJim  \r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=imjimmurphy","name":"imjimmurphy","emailAddress":"jim dot murphy at pobox dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jim Murphy","active":true},"created":"2008-08-26T19:41:08.150+0000","updated":"2008-08-26T19:41:08.150+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346872/comment/12628473","id":"12628473","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=goksron","name":"goksron","emailAddress":"goksron at yahoo dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lance Norskog","active":true},"body":"A slight nit: Unicode contains three characters, fffD, fffE, and fffF, which are not supposed to appear in any document. One (fffD i think) is the offical \"not a character\" character, and should be used for the purpose of separating terms.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=goksron","name":"goksron","emailAddress":"goksron at yahoo dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lance Norskog","active":true},"created":"2008-09-04T21:47:41.143+0000","updated":"2008-09-04T21:47:41.143+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346872/comment/12628475","id":"12628475","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=goksron","name":"goksron","emailAddress":"goksron at yahoo dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lance Norskog","active":true},"body":"Another bigger nit: the last time I studied this, the HTML stripper code did not pull alt-text fields as searchable tags.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=goksron","name":"goksron","emailAddress":"goksron at yahoo dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lance Norskog","active":true},"created":"2008-09-04T21:48:23.425+0000","updated":"2008-09-04T21:48:23.425+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346872/comment/12628650","id":"12628650","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pakore","name":"pakore","emailAddress":"pakore at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Francisco Sanmartn","active":true},"body":"The patch is for solr 1.3? \r\n\r\nI tried to apply the patch to solr 1.2 but it fails :(\r\n\r\nCan anybody complete the \"affected version\" and \"fix version\" field? thanks!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pakore","name":"pakore","emailAddress":"pakore at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Francisco Sanmartn","active":true},"created":"2008-09-05T15:01:34.257+0000","updated":"2008-09-05T15:01:34.257+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346872/comment/12641883","id":"12641883","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=solrize","name":"solrize","emailAddress":"no at email dot please","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"solrize","active":true},"body":"This problem is still present in solr 1.3.0 and I'm getting a ton of those \"mark invalid\" exceptions.  Is this really a minor issue?!!!!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=solrize","name":"solrize","emailAddress":"no at email dot please","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"solrize","active":true},"created":"2008-10-22T15:14:41.632+0000","updated":"2008-10-22T15:14:41.632+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346872/comment/12717688","id":"12717688","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mertsakarya","name":"mertsakarya","emailAddress":"mertsakarya at hotmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mert Sakarya","active":true},"body":"I think this is a problem of Microsoft Word. No one can say that;\r\n\r\n      ...valid html...<?xml:namespace prefix = o />...valid html...\r\n\r\nis a valid HTML. Any HTMLParser should look for a \"?>\" after a \"<?\"\r\n\r\nBUT! As a solution, I modified line 644 at HTMLStripReader.java as;\r\n\r\n      //if (ch=='?' && peek()=='>') {\r\n      if ((ch=='?' || ch=='/') && peek()=='>') { //This fixes Office Word problem, but might cause other problems!!! Be very careful.\r\n\r\nAnd created my own HTMLStripReader in another jar file.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mertsakarya","name":"mertsakarya","emailAddress":"mertsakarya at hotmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mert Sakarya","active":true},"created":"2009-06-09T14:26:52.129+0000","updated":"2009-06-09T14:26:52.129+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346872/comment/12749421","id":"12749421","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andersm","name":"andersm","emailAddress":"jira at solr dot kalibalik dot dk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Anders Melchiorsen","active":true},"body":"I found the issue with entity replacement breaking up words, and created SOLR-1394.\r\n\r\nMy patch in that issue is to HTMLStripCharFilter.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andersm","name":"andersm","emailAddress":"jira at solr dot kalibalik dot dk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Anders Melchiorsen","active":true},"created":"2009-08-31T08:23:37.100+0000","updated":"2009-08-31T08:23:37.100+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346872/comment/12848542","id":"12848542","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dsmiley","name":"dsmiley","emailAddress":"dsmiley at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dsmiley&avatarId=10110","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dsmiley&avatarId=10110","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dsmiley&avatarId=10110","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dsmiley&avatarId=10110"},"displayName":"David Smiley","active":true},"body":"I was just reading this whole thread and SOLR-1394.  It seems this issue can be closed as a duplicate of SOLR-1394.  No?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dsmiley","name":"dsmiley","emailAddress":"dsmiley at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dsmiley&avatarId=10110","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dsmiley&avatarId=10110","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dsmiley&avatarId=10110","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dsmiley&avatarId=10110"},"displayName":"David Smiley","active":true},"created":"2010-03-23T04:33:02.768+0000","updated":"2010-03-23T04:33:02.768+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346872/comment/13027629","id":"13027629","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mpdude","name":"mpdude","emailAddress":"mp at webfactory dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matthias Pigulla","active":true},"body":"I don't think it's a duplicate and the issue is still unresolved at least in regard to [#comment-12625835] and the 1.4.1 release.\r\n\r\nThe input string \"<??>xx yy xx\" will have the start offsets for xx, yy and xx at 3, 6 and 9 respectively and is off by one.\r\n\r\n\"<? ?><? ?>xx yy xx\" [spaces added between question marks for JIRA display] will even have 6, 9 and 12, that is, every \"<??>\" (as a special \"degenerated\" kind of XML PI) will shift the offset by one.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mpdude","name":"mpdude","emailAddress":"mp at webfactory dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matthias Pigulla","active":true},"created":"2011-05-02T12:00:05.011+0000","updated":"2011-05-02T12:02:39.649+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346872/comment/13192226","id":"13192226","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=steve_rowe","name":"steve_rowe","emailAddress":"sarowe at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Steve Rowe","active":true},"body":"Fixed by LUCENE-3690.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=steve_rowe","name":"steve_rowe","emailAddress":"sarowe at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Steve Rowe","active":true},"created":"2012-01-24T15:55:48.941+0000","updated":"2012-01-24T15:55:48.941+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/SOLR-42/votes","votes":4,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i03z7z:"}}